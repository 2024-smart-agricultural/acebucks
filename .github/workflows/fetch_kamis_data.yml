name: Fetch KAMIS EcoPriceList

on:
  schedule:
    - cron: '*/15 * * * *' # 매 15분마다 실행

jobs:
  fetch_eco_price_list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Fetch Eco Price List
        env:
          KAMIS_KEY: ${{ secrets.KAMIS_KEY }}  # 올바른 변수 사용
          P_CERT_ID: ${{ secrets.P_CERT_ID }}
          
        run: |
          # API 요청을 통해 JSON 파일로 저장
          curl -w "%{http_code}\n" -X GET "http://www.kamis.or.kr/service/price/xml.do?action=EcoPriceList&apikey=${KAMIS_KEY}&p_cert_key=${KAMIS_KEY}&p_cert_id=${P_CERT_ID}&price_type=0&p_returntype=json" -o eco_price_list.json

          # 상태 코드 확인
          if [ $? -eq 0 ]; then
              echo "API 요청 성공"
          else
              echo "API 요청 실패"
          fi
          
          # 파일이 생성되었는지 확인
          if [ -f eco_price_list.json ]; then
              # acebucks/docs 디렉터리로 파일 이동
              mkdir -p acebucks/docs
              mv eco_price_list.json acebucks/docs/eco_price_list.json
          else
              echo "eco_price_list.json 파일이 생성되지 않았습니다."
          fi

          # acebucks/docs 디렉터리로 파일 이동
          mkdir -p acebucks/docs
          mv eco_price_list.json acebucks/docs/eco_price_list.json

      - name: Commit and Push JSON File
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add acebucks/docs/eco_price_list.json
          git commit -m 'Update eco price list every 10 minutes'
          git push
