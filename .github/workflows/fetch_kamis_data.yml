name: Fetch KAMIS PriceList

on:
  schedule:
    - cron: '*/15 * * * *' # 매 15분마다 실행

jobs:
  fetch_price_list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # v3으로 업데이트

      - name: Fetch Price List
        env:
          KAMIS_KEY: ${{ secrets.KAMIS_KEY }}  # 올바른 변수 사용
          P_CERT_ID: ${{ secrets.P_CERT_ID }}
          
        run: |
          # API 요청을 통해 JSON 파일로 저장
          echo "PriceList 데이터를 요청합니다..."
          response=$(curl -w "%{http_code}" -X GET "https://www.kamis.or.kr/service/price/xml.do?action=EcoPriceList&apikey=${KAMIS_KEY}&p_cert_key=${KAMIS_KEY}&p_cert_id=${P_CERT_ID}&price_type=0&p_returntype=json" -o price_list.json)
          
          if [ "$response" -eq 200 ]; then
              echo "API 요청 성공: price_list.json 파일을 저장했습니다."
          else
              echo "API 요청 실패, 상태 코드: $response"
              exit 1
          fi
          
          # price_list.json 파일이 생성되었는지 확인
          if [ -f "price_list.json" ]; then
              mkdir -p docs
              mv price_list.json docs/price_list.json
              echo "파일이 docs/price_list.json으로 이동되었습니다."
          else
              echo "price_list.json 파일이 생성되지 않았습니다. 파일 경로를 다시 확인하세요."
              exit 1
          fi
          
      - name: Commit and Push JSON File
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          if [ -s docs/price_list.json ]; then
              git add docs/price_list.json
              git commit -m 'Update price list every 15 minutes'
              git push
          else
              echo "No changes to commit."
              exit 0  # 변경 사항이 없을 때 종료 코드를 0으로 설정하여 성공 처리
          fi
